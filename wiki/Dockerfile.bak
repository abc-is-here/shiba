FROM mediawiki:1.41.1

# Create LocalSettings.php with your database configuration
RUN cat > /var/www/html/LocalSettings.php << 'EOF'
<?php
# This file was automatically generated for Shiba Wiki
# MediaWiki 1.41.1 LocalSettings.php

# Database settings
$wgDBtype = "mysql";
$wgDBserver = getenv('DB_HOST') ?: "database";
$wgDBname = getenv('DB_NAME') ?: "wikidb";
$wgDBuser = getenv('DB_USER') ?: "wikiuser";
$wgDBpassword = getenv('DB_PASSWORD') ?: "wikipass";

# Site settings
$wgSitename = getenv('SITE_NAME') ?: "Shiba Wiki";
$wgMetaNamespace = "Shiba_Wiki";

# Server settings
$wgServer = getenv('SITE_SERVER') ?: "http://localhost:8080";
$wgScriptPath = "";
$wgResourceBasePath = $wgScriptPath;

# Upload settings
$wgEnableUploads = true;
$wgUseImageMagick = true;
$wgImageMagickConvertCommand = "/usr/bin/convert";

# Security settings
$wgSecretKey = "dEsrld222IAexg2XZLFkFsd8OHOpdyl4jB5qWoof5g";
$wgUpgradeKey = "your-upgrade-key-here-change-this";

# Admin user
$wgEmergencyContact = getenv('ADMIN_EMAIL') ?: "admin@example.com";
$wgPasswordSender = getenv('ADMIN_EMAIL') ?: "admin@example.com";

# Cache settings
$wgMainCacheType = CACHE_ACCEL;
$wgMemCachedServers = [];

# Language settings
$wgLanguageCode = "en";
$wgLocaltimezone = "UTC";

# Email settings
$wgEnableEmail = true;
$wgEnableUserEmail = true;
$wgEnotifUserTalk = false;
$wgEnotifWatchlist = false;
$wgEmailAuthentication = true;

# File uploads
$wgFileExtensions = array( 'png', 'gif', 'jpg', 'jpeg', 'webp', 'svg', 'pdf', 'doc', 'docx', 'txt', 'zip' );
$wgMaxUploadSize = 100 * 1024 * 1024; // 100MB

# Performance settings
$wgShowExceptionDetails = false;
$wgShowDBErrorBacktrace = false;
$wgShowSQLErrors = false;

# Extensions (basic ones)
$wgEnableAPI = true;
$wgEnableWriteAPI = true;

# End of automatically generated LocalSettings.php
EOF

# Set proper permissions
RUN chown -R www-data:www-data /var/www/html
RUN chmod 644 /var/www/html/LocalSettings.php

# Create images directory with proper permissions
RUN mkdir -p /var/www/html/images
RUN chown -R www-data:www-data /var/www/html/images
RUN chmod 755 /var/www/html/images
